<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Trajectory Player</title>
    <link rel="stylesheet" href="index.css">
    <script type="module">
        const experiments_base_path = "../../experiments/"


        import { DynamicFileSystem } from "./DynamicFileSystem.js";
        import { StaticFileSystem } from "./StaticFileSystem.js";
        import {Index, group_by} from "./Index.js";
        import {TrajectoryPlayer} from "./TrajectoryPlayer.js";

        window.group_by = group_by // make available in the developer console
        const fs = new StaticFileSystem(experiments_base_path)
        const idx = new Index(fs)
        window.idx = idx
        const idx_promise = idx.refresh()

        import { Explorer } from "./Explorer.js";
        const explorer = new Explorer(experiments_base_path, idx, {"verbose": true})
        const explorerContainer = document.getElementById('explorer-container');
        explorerContainer.appendChild(explorer.getContainer());

        import { Zoo } from "./Zoo.js";
        const zoo = new Zoo(experiments_base_path, idx, {"verbose": true})
        const zooContainer = document.getElementById('zoo-container');
        zooContainer.appendChild(zoo.getContainer());


        function populate_latest_run(run){
            const trajectory_player = new TrajectoryPlayer(run.ui_jsm);
            const trajectory_player_container = document.getElementById('extrack-trajectory-player-container')
            trajectory_player_container.appendChild(trajectory_player.getCanvas());
            trajectory_player_container.style.display = "block";
            const step = Object.keys(run.steps).sort().reverse()[0]
            trajectory_player.playTrajectories(run.steps[step].trajectories_compressed);

            const latest_run_experiment = document.getElementById('latest-run-experiment')
            latest_run_experiment.innerText = run.config.experiment
            const latest_run_commit_hash = document.getElementById('latest-run-commit-hash')
            latest_run_commit_hash.innerText = run.config.commit
            const latest_run_name = document.getElementById('latest-run-name')
            latest_run_name.innerText = run.config.name
            const latest_run_config = document.getElementById('latest-run-config')
            latest_run_config.innerText = JSON.stringify(run.config.population)
            const latest_run_seed = document.getElementById('latest-run-seed')
            latest_run_seed.innerText = run.config.seed
            const latest_run_checkpoint = document.getElementById('latest-run-checkpoint')
            latest_run_checkpoint.innerText = parseInt(step).toString()

            const latest_run_description = document.getElementById('latest-run-description')
            const latest_run_description_loading = document.getElementById('latest-run-description-loading')
            latest_run_description.style.display = "block"
            latest_run_description_loading.style.display = "none"
        }
        idx_promise.then(() => {
            const runs_with_ui = idx.run_list.filter(run => run.ui_jsm)
            const runs_with_steps = runs_with_ui.filter(run => run.steps && Object.keys(run.steps).length > 0)
            const run = runs_with_steps[0]
            populate_latest_run(run)
        })

    </script>
</head>
<body>
    <h1>Latest Run</h1>
    <div id="latest-run-container">
        <div id="latest-run-description" class="latest-run-container-element">
            <b>Experiment</b>: <span id="latest-run-experiment"></span>
            </br>
            <b>Commit Hash</b>: <span id="latest-run-commit-hash"></span>
            </br>
            <b>Name</b>: <span id="latest-run-name"></span>
            </br>
            <b>Config</b>: <span id="latest-run-config"></span>
            </br>
            <b>Seed</b>: <span id="latest-run-seed"></span>
            </br>
            <b>Checkpoint</b>: <span id="latest-run-checkpoint"></span>
        </div>
        <div id="latest-run-description-loading">Loading...</div>
        <div id="extrack-trajectory-player-container"></div>
    </div>
    <h1>Run Explorer</h1>
    <div id="explorer-container"></div>
    <h1>Learning Curves</h1>
    <div class="zoo-container-container">
        <div id="zoo-container" class="zoo-container-container-element"></div>
    </div>
</body>
</html>

